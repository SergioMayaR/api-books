const express = require("express"); //Declara express
const router = express.Router(); //Obtiene las rutas
const mysqlConection = require("../database"); //Importa la conexión de database
const response = require("../network/response");
var nodemailer = require('nodemailer');
const jwt = require('jsonwebtoken')
const bcryptjs = require('bcryptjs')
const { promisify } = require('util')
/* 
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: 'noreplyupiicsa@gmail.com',
        pass: 'upiicsa2019'
    }
});  */
const transporter = nodemailer.createTransport({
    host: "smtp-mail.outlook.com", // hostname
    secureConnection: false, // TLS requires secureConnection to be false
    port: 587, // port for secure SMTP
    tls: {
        ciphers: 'SSLv3'
    },
    auth: {
        user: 'librosdemexico@outlook.com',
        pass: 'books2022*_$'
    }
});

router.post("/api/empleoyes/test", (req, res) => {
    var pass = createPassword()
    let passHash = "await bcryptjs.hash(pass, 8)"
    var titles = "Contraseña temporal"
    var mensaje = "";
    var liga = "https://quiet-ravine-75252.herokuapp.com/"
    var dataInfosL = "<p style='margin: 15px; '>El presente correo es para darle su nueva contraeña temporal<br></p>" +
        "<p style= 'width: 98%; display: block; text-size:16px; text-align:justify;'> Contraseña:" + " " + pass + "</p>" +
        mensaje
    var logo = "https://quiet-ravine-75252.herokuapp.com/static/media/libros_logo.7ec1ec02.png";
    var message = "<html><head><style type=\"text/css\" id=\"media-query\"> body{margin: 0; padding: 0;}table, tr, td{vertical-align: top; border-collapse: collapse;}.ie-browser table, .mso-container table{table-layout: fixed;}*{line-height: inherit;}a[x-apple-data-detectors=true]{color: inherit !important; text-decoration: none !important;}[owa] .img-container div, [owa] .img-container button{display: block !important;}[owa] .fullwidth button{width: 100% !important;}[owa] .block-grid .col{display: table-cell; float: none !important; vertical-align: top;}.ie-browser .num12, .ie-browser .block-grid, [owa] .num12, [owa] .block-grid{width: 600px !important;}.ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div{line-height: 100%;}.ie-browser .mixed-two-up .num4, [owa] .mixed-two-up .num4{width: 200px !important;}.ie-browser .mixed-two-up .num8, [owa] .mixed-two-up .num8{width: 400px !important;}.ie-browser .block-grid.two-up .col, [owa] .block-grid.two-up .col{width: 300px !important;}.ie-browser .block-grid.three-up .col, [owa] .block-grid.three-up .col{width: 200px !important;}.ie-browser .block-grid.four-up .col, [owa] .block-grid.four-up .col{width: 150px !important;}.ie-browser .block-grid.five-up .col, [owa] .block-grid.five-up .col{width: 120px !important;}.ie-browser .block-grid.six-up .col, [owa] .block-grid.six-up .col{width: 100px !important;}.ie-browser .block-grid.seven-up .col, [owa] .block-grid.seven-up .col{width: 85px !important;}.ie-browser .block-grid.eight-up .col, [owa] .block-grid.eight-up .col{width: 75px !important;}.ie-browser .block-grid.nine-up .col, [owa] .block-grid.nine-up .col{width: 66px !important;}.ie-browser .block-grid.ten-up .col, [owa] .block-grid.ten-up .col{width: 60px !important;}.ie-browser .block-grid.eleven-up .col, [owa] .block-grid.eleven-up .col{width: 54px !important;}.ie-browser .block-grid.twelve-up .col, [owa] .block-grid.twelve-up .col{width: 50px !important;}@media only screen and (min-width: 620px){.block-grid{width: 600px !important;}.block-grid .col{vertical-align: top;}.block-grid .col.num12{width: 600px !important;}.block-grid.mixed-two-up .col.num4{width: 200px !important;}.block-grid.mixed-two-up .col.num8{width: 400px !important;}.block-grid.two-up .col{width: 300px !important;}.block-grid.three-up .col{width: 200px !important;}.block-grid.four-up .col{width: 150px !important;}.block-grid.five-up .col{width: 120px !important;}.block-grid.six-up .col{width: 100px !important;}.block-grid.seven-up .col{width: 85px !important;}.block-grid.eight-up .col{width: 75px !important;}.block-grid.nine-up .col{width: 66px !important;}.block-grid.ten-up .col{width: 60px !important;}.block-grid.eleven-up .col{width: 54px !important;}.block-grid.twelve-up .col{width: 50px !important;}}@media (max-width: 620px){.block-grid, .col{min-width: 320px !important; max-width: 100% !important; display: block !important;}.block-grid{width: calc(100% - 40px) !important;}.col{width: 100% !important;}.col>div{margin: 0 auto;}img.fullwidth, img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px; max-height: 0px; max-width: 0px; display: none; overflow: hidden; font-size: 0px;}}</style>" +
        "</head><body class=\"clean-body\" style=\"margin: 0;padding: 0;-webkit-text-size-adjust: 100%;background-color: #F3F3F3\"> <style type=\"text/css\" id=\"media-query-bodytag\"> @media (max-width: 520px){.block-grid{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col>div{margin: 0 auto;}img.fullwidth{max-width: 100% !important;}img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px !important; max-height: 0px !important; max-width: 0px !important; display: none !important; overflow: hidden !important; font-size: 0px !important;}}</style> <table class=\"nl-container\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #F3F3F3;width: 100%\" cellpadding=\"0\" cellspacing=\"0\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top\"> <div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> &#160; </div></div></div></div></div></div><div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #FFFFFF;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:#FFFFFF;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <div align=\"center\" class=\"img-container center fixedwidth \" style=\"background:#051829;padding-right: 10px; padding-left: 10px;\"> <div style=\"line-height:10px;font-size:1px\">&#160;</div><a  target=\"_blank\"> <img class=\"center fixedwidth\" align=\"center\" border=\"0\" src=\"" + logo + "\" alt=\"Image\" title=\"Image\" style=\"outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: block !important;border: none;height: auto;float: none;width: 100%;max-width: 240px\" width=\"240\"> </a> <div style=\"line-height:10px;font-size:1px\">&#160;</div></div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: #FFFFFF; width: 100% !important;\">" +
        "<div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:0px; padding-bottom:0px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 5px;padding-left: 5px;padding-top: 5px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span></span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#134C75;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:120%; padding-right: 30px; padding-left: 30px; padding-top: 10px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:14px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#134C75;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 24px; line-height: 28px;\"><strong>" + titles + "</strong></span></p></div></div></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 10px;padding-left: 10px;padding-top: 15px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #DDDDDD;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#4A4A4A;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:180%; padding-right: 25px; padding-left: 25px; padding-top: 15px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:22px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#4A4A4A;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 25px\"><span style=\"font-size: 15px; line-height: 27px;\"><strong><span style=\"line-height: 27px; font-size: 15px;\">Estimado usuario:</span></strong></span><span style=\"font-size: 14px; line-height: 25px;\"><span style=\"line-height: 25px; font-size: 14px;\"></span></span></p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family: Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 0px;\">" +
        "<div style=\"font-size:12px;line-height:18px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;margin-left: 25px\"> <p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left\"> <span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\">" +
        "" + dataInfosL + "<br>" +
        "</span> </p><p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left; margin-top: 10px; margin-left: 15px\"><span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\"><br>" +
        "</span> </p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family:Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 20px;\"> <div style=\"line-height:18px;font-size:12px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;\"> <p style=\"margin: 0;line-height: 18px;text-align: left;font-size: 12px\"><span style=\"font-size: 14px; line-height: 21px;\">Para más información haga click en el siguiente enlace:</span></p></div></div></div><div align=\"center\" class=\"button-container center \" style=\"padding-right: 10px; padding-left: 10px; padding-top:10px; padding-bottom:10px;\">" +
        "<a href=\"" + liga + "\" target=\"_blank\" style=\"display: block;text-decoration: none;-webkit-text-size-adjust: none;text-align: center;color: #ffffff; background-color: #49a6e8; border-radius: 24px; -webkit-border-radius: 24px; -moz-border-radius: 24px; max-width: 152px; width: 102px;width: auto; border-top: 0px solid transparent; border-right: 0px solid transparent; border-bottom: 0px solid transparent; border-left: 0px solid transparent; padding-top: 5px; padding-right: 25px; padding-bottom: 5px; padding-left: 25px; font-family: Arial, Helvetica, Arial, sans-serif;mso-border-alt: none\"> <span style=\"font-family:Arial, Helvetica, Arial, sans-serif;font-size:16px;line-height:32px;\"><span style=\"font-size: 14px;\">Consultar aquí</span></span> </a> </div><div class=\"\"> <div style=\"color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;line-height:120%; padding-right: 10px; padding-left: 10px; padding-top: 15px; padding-bottom: 10px;\"> <div style=\"font-size:12px;line-height:14px;color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 11px; line-height: 13px;\"></span><span style=\"font-size: 11px; line-height: 13px;\">" +
        "<a style=\"color:#8F8F8F;text-decoration: underline;\" href=\"" + liga + "\" target=\"_blank\" rel=\"noopener\"></a></span></p></div></div></div><div align=\"center\" class=\"img-container center autowidth fullwidth \" style=\"padding-right: 0px; padding-left: 0px;\"> </div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 25px;padding-left: 25px;padding-top: 25px;padding-bottom: 25px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> </div></div></div></div></div></div></td></tr></tbody> </table> </body></html>"
    var mailOptions = {
        from: 'NoReplay <librosdemexico@outlook.com>',
        replyTo: 'librosdemexico@outlook.com',
        to: "saxel.12194@gmail.com",
        subject: titles,
        html: message
    };
    transporter.sendMail(mailOptions, function (error, info) {
        console.log(error)
        console.log(info)
        res.send("ok")
    })
})
//Por el METODO POST Guarda un nuevo registro dentro de la BD
router.post("/api/empleoyes/", verifyToken, async (req, res) => {
    const { id, name, email, type } = req.body;
    var pass = createPassword()
    let passHash = await bcryptjs.hash(pass, 8)
    mysqlConection.query("SELECT * from users where correo = ?",
        [email], (err, rows, fields) => {
            if (!err) {
                if (rows.length > 0) {
                    body = {
                        error: "El usuario ya fue agregado"
                    }
                    response.error(req, res, true, false, body, 403, "Error")
                } else {

                    const query = "INSERT INTO users (nombre, correo,tipo,pass) VALUES (?, ?, ?,?)";
                    mysqlConection.query(query, [name, email, type, passHash], (err, rows, fields) => {
                        var titles = "Contraseña temporal"
                        var mensaje = "";
                        var liga = "https://quiet-ravine-75252.herokuapp.com/"
                        var dataInfosL = "<p style='margin: 15px; '>El presente correo es para darle su nueva contraeña temporal<br></p>" +
                            "<p style= 'width: 98%; display: block; text-size:16px; text-align:justify;'> Contraseña:" + " " + pass + "</p>" +
                            mensaje
                        var logo = "https://quiet-ravine-75252.herokuapp.com/static/media/libros_logo.7ec1ec02.png";
                        var message = "<html><head><style type=\"text/css\" id=\"media-query\"> body{margin: 0; padding: 0;}table, tr, td{vertical-align: top; border-collapse: collapse;}.ie-browser table, .mso-container table{table-layout: fixed;}*{line-height: inherit;}a[x-apple-data-detectors=true]{color: inherit !important; text-decoration: none !important;}[owa] .img-container div, [owa] .img-container button{display: block !important;}[owa] .fullwidth button{width: 100% !important;}[owa] .block-grid .col{display: table-cell; float: none !important; vertical-align: top;}.ie-browser .num12, .ie-browser .block-grid, [owa] .num12, [owa] .block-grid{width: 600px !important;}.ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div{line-height: 100%;}.ie-browser .mixed-two-up .num4, [owa] .mixed-two-up .num4{width: 200px !important;}.ie-browser .mixed-two-up .num8, [owa] .mixed-two-up .num8{width: 400px !important;}.ie-browser .block-grid.two-up .col, [owa] .block-grid.two-up .col{width: 300px !important;}.ie-browser .block-grid.three-up .col, [owa] .block-grid.three-up .col{width: 200px !important;}.ie-browser .block-grid.four-up .col, [owa] .block-grid.four-up .col{width: 150px !important;}.ie-browser .block-grid.five-up .col, [owa] .block-grid.five-up .col{width: 120px !important;}.ie-browser .block-grid.six-up .col, [owa] .block-grid.six-up .col{width: 100px !important;}.ie-browser .block-grid.seven-up .col, [owa] .block-grid.seven-up .col{width: 85px !important;}.ie-browser .block-grid.eight-up .col, [owa] .block-grid.eight-up .col{width: 75px !important;}.ie-browser .block-grid.nine-up .col, [owa] .block-grid.nine-up .col{width: 66px !important;}.ie-browser .block-grid.ten-up .col, [owa] .block-grid.ten-up .col{width: 60px !important;}.ie-browser .block-grid.eleven-up .col, [owa] .block-grid.eleven-up .col{width: 54px !important;}.ie-browser .block-grid.twelve-up .col, [owa] .block-grid.twelve-up .col{width: 50px !important;}@media only screen and (min-width: 620px){.block-grid{width: 600px !important;}.block-grid .col{vertical-align: top;}.block-grid .col.num12{width: 600px !important;}.block-grid.mixed-two-up .col.num4{width: 200px !important;}.block-grid.mixed-two-up .col.num8{width: 400px !important;}.block-grid.two-up .col{width: 300px !important;}.block-grid.three-up .col{width: 200px !important;}.block-grid.four-up .col{width: 150px !important;}.block-grid.five-up .col{width: 120px !important;}.block-grid.six-up .col{width: 100px !important;}.block-grid.seven-up .col{width: 85px !important;}.block-grid.eight-up .col{width: 75px !important;}.block-grid.nine-up .col{width: 66px !important;}.block-grid.ten-up .col{width: 60px !important;}.block-grid.eleven-up .col{width: 54px !important;}.block-grid.twelve-up .col{width: 50px !important;}}@media (max-width: 620px){.block-grid, .col{min-width: 320px !important; max-width: 100% !important; display: block !important;}.block-grid{width: calc(100% - 40px) !important;}.col{width: 100% !important;}.col>div{margin: 0 auto;}img.fullwidth, img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px; max-height: 0px; max-width: 0px; display: none; overflow: hidden; font-size: 0px;}}</style>" +
                            "</head><body class=\"clean-body\" style=\"margin: 0;padding: 0;-webkit-text-size-adjust: 100%;background-color: #F3F3F3\"> <style type=\"text/css\" id=\"media-query-bodytag\"> @media (max-width: 520px){.block-grid{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col>div{margin: 0 auto;}img.fullwidth{max-width: 100% !important;}img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px !important; max-height: 0px !important; max-width: 0px !important; display: none !important; overflow: hidden !important; font-size: 0px !important;}}</style> <table class=\"nl-container\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #F3F3F3;width: 100%\" cellpadding=\"0\" cellspacing=\"0\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top\"> <div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> &#160; </div></div></div></div></div></div><div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #FFFFFF;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:#FFFFFF;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <div align=\"center\" class=\"img-container center fixedwidth \" style=\"background:#051829;padding-right: 10px; padding-left: 10px;\"> <div style=\"line-height:10px;font-size:1px\">&#160;</div><a  target=\"_blank\"> <img class=\"center fixedwidth\" align=\"center\" border=\"0\" src=\"" + logo + "\" alt=\"Image\" title=\"Image\" style=\"outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: block !important;border: none;height: auto;float: none;width: 100%;max-width: 240px\" width=\"240\"> </a> <div style=\"line-height:10px;font-size:1px\">&#160;</div></div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: #FFFFFF; width: 100% !important;\">" +
                            "<div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:0px; padding-bottom:0px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 5px;padding-left: 5px;padding-top: 5px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span></span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#134C75;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:120%; padding-right: 30px; padding-left: 30px; padding-top: 10px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:14px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#134C75;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 24px; line-height: 28px;\"><strong>" + titles + "</strong></span></p></div></div></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 10px;padding-left: 10px;padding-top: 15px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #DDDDDD;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#4A4A4A;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:180%; padding-right: 25px; padding-left: 25px; padding-top: 15px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:22px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#4A4A4A;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 25px\"><span style=\"font-size: 15px; line-height: 27px;\"><strong><span style=\"line-height: 27px; font-size: 15px;\">Estimado usuario:</span></strong></span><span style=\"font-size: 14px; line-height: 25px;\"><span style=\"line-height: 25px; font-size: 14px;\"></span></span></p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family: Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 0px;\">" +
                            "<div style=\"font-size:12px;line-height:18px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;margin-left: 25px\"> <p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left\"> <span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\">" +
                            "" + dataInfosL + "<br>" +
                            "</span> </p><p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left; margin-top: 10px; margin-left: 15px\"><span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\"><br>" +
                            "</span> </p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family:Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 20px;\"> <div style=\"line-height:18px;font-size:12px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;\"> <p style=\"margin: 0;line-height: 18px;text-align: left;font-size: 12px\"><span style=\"font-size: 14px; line-height: 21px;\">Para más información haga click en el siguiente enlace:</span></p></div></div></div><div align=\"center\" class=\"button-container center \" style=\"padding-right: 10px; padding-left: 10px; padding-top:10px; padding-bottom:10px;\">" +
                            "<a href=\"" + liga + "\" target=\"_blank\" style=\"display: block;text-decoration: none;-webkit-text-size-adjust: none;text-align: center;color: #ffffff; background-color: #49a6e8; border-radius: 24px; -webkit-border-radius: 24px; -moz-border-radius: 24px; max-width: 152px; width: 102px;width: auto; border-top: 0px solid transparent; border-right: 0px solid transparent; border-bottom: 0px solid transparent; border-left: 0px solid transparent; padding-top: 5px; padding-right: 25px; padding-bottom: 5px; padding-left: 25px; font-family: Arial, Helvetica, Arial, sans-serif;mso-border-alt: none\"> <span style=\"font-family:Arial, Helvetica, Arial, sans-serif;font-size:16px;line-height:32px;\"><span style=\"font-size: 14px;\">Consultar aquí</span></span> </a> </div><div class=\"\"> <div style=\"color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;line-height:120%; padding-right: 10px; padding-left: 10px; padding-top: 15px; padding-bottom: 10px;\"> <div style=\"font-size:12px;line-height:14px;color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 11px; line-height: 13px;\"></span><span style=\"font-size: 11px; line-height: 13px;\">" +
                            "<a style=\"color:#8F8F8F;text-decoration: underline;\" href=\"" + liga + "\" target=\"_blank\" rel=\"noopener\"></a></span></p></div></div></div><div align=\"center\" class=\"img-container center autowidth fullwidth \" style=\"padding-right: 0px; padding-left: 0px;\"> </div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 25px;padding-left: 25px;padding-top: 25px;padding-bottom: 25px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> </div></div></div></div></div></div></td></tr></tbody> </table> </body></html>"
                        var mailOptions = {
                            from: 'NoReplay <librosdemexico@outlook.com>',
                            replyTo: 'librosdemexico@outlook.com',
                            to: email,
                            subject: titles,
                            html: message
                        };
                        //transporter.sendMail(mailOptions, function (error, info) {
                        if (!err) {
                            let body = {
                                paass: pass,
                                isCreate: true
                            }
                            response.success(req, res, false, true, body, 200);
                        } else {
                        }
                        //})
                    });
                }
            } else {
                res.json(err); //Muestra el error
            }
        });
});

function createPassword() {
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for (var i = 0; i < 9; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}

router.post("/api/login/", async (req, res) => {
    try {
        const { email, pass } = req.body;
        if (!email) {
            response.error(req, res, true, false, "Ingrese un correo", 401, "Ingrese un correo");
        } else if (!pass) {
            response.error(req, res, true, false, "Ingrese una contraseña", 401, "Ingrese una contraseña");
        } else {
            mysqlConection.query('SELECT * FROM users WHERE correo = ?', [email], async (error, results) => {
                if (results.length == 0) {
                    response.error(req, res, true, false, "Correo/ contraseña invalida", 401, "Correo/ contraseña invalida");
                } else if (!(await bcryptjs.compare(pass, results[0].pass))) {
                    response.error(req, res, true, false, "Correo/ contraseña invalida", 401, "Correo/ contraseña invalida");
                } else {
                    const id = results[0].id
                    const token = jwt.sign({ id: id }, "secret_token", {
                        expiresIn: "8h"
                    })
                    const cookiesOptions = {
                        expires: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),
                        httpOnly: true
                    }
                    let profile = results[0].tipo;
                    let emailUser = email;
                    let nameUser = results[0].nombre
                    let body = {
                        'is_security': token,
                        'is_Profile': profile,
                        'is_Emial': emailUser,
                        'is_Name': nameUser,
                        "success": true,
                        "mess": "Bienvenido " + results[0].nombre,
                        expires: cookiesOptions.expires
                    }
                    response.success(req, res, false, true, body, 200)
                }
            })
        }
    } catch (error) {
    }
});

router.post("/api/restPassword", async (req, res) => {
    var array = []
    try {
        const { email } = req.body;
        if (!email) {
            response.error(req, res, true, false, "Ingrese un correo", 401, "Ingrese un correo");
        } else {
            var pass = createPassword()
            let passHash = await bcryptjs.hash(pass, 8)
            array.push(passHash)
            mysqlConection.query('SELECT * FROM users WHERE correo = ?', [email], async (error, results) => {
                array.push(results[0].id)
                if (results.length == 0) {
                    response.error(req, res, true, false, "Correo invalida", 401, "Correo invalida");
                } else {
                    const query = "UPDATE users SET temporal = ? WHERE (id = ?)";
                    mysqlConection.query(query, array, (err, rows, fields) => {
                        var titles = "Contraseña temporal"
                        var mensaje = "";
                        var liga = "https://quiet-ravine-75252.herokuapp.com/restPassword"
                        var dataInfosL = "<p style='margin: 15px; '>El presente correo es para darle su nueva contraeña temporal<br></p>" +
                            "<p style= 'width: 98%; display: block; text-size:16px; text-align:justify;'> Contraseña:" + " " + pass + "</p>" +
                            mensaje
                        var logo = "https://quiet-ravine-75252.herokuapp.com/static/media/libros_logo.7ec1ec02.png";
                        var message = "<html><head><style type=\"text/css\" id=\"media-query\"> body{margin: 0; padding: 0;}table, tr, td{vertical-align: top; border-collapse: collapse;}.ie-browser table, .mso-container table{table-layout: fixed;}*{line-height: inherit;}a[x-apple-data-detectors=true]{color: inherit !important; text-decoration: none !important;}[owa] .img-container div, [owa] .img-container button{display: block !important;}[owa] .fullwidth button{width: 100% !important;}[owa] .block-grid .col{display: table-cell; float: none !important; vertical-align: top;}.ie-browser .num12, .ie-browser .block-grid, [owa] .num12, [owa] .block-grid{width: 600px !important;}.ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div{line-height: 100%;}.ie-browser .mixed-two-up .num4, [owa] .mixed-two-up .num4{width: 200px !important;}.ie-browser .mixed-two-up .num8, [owa] .mixed-two-up .num8{width: 400px !important;}.ie-browser .block-grid.two-up .col, [owa] .block-grid.two-up .col{width: 300px !important;}.ie-browser .block-grid.three-up .col, [owa] .block-grid.three-up .col{width: 200px !important;}.ie-browser .block-grid.four-up .col, [owa] .block-grid.four-up .col{width: 150px !important;}.ie-browser .block-grid.five-up .col, [owa] .block-grid.five-up .col{width: 120px !important;}.ie-browser .block-grid.six-up .col, [owa] .block-grid.six-up .col{width: 100px !important;}.ie-browser .block-grid.seven-up .col, [owa] .block-grid.seven-up .col{width: 85px !important;}.ie-browser .block-grid.eight-up .col, [owa] .block-grid.eight-up .col{width: 75px !important;}.ie-browser .block-grid.nine-up .col, [owa] .block-grid.nine-up .col{width: 66px !important;}.ie-browser .block-grid.ten-up .col, [owa] .block-grid.ten-up .col{width: 60px !important;}.ie-browser .block-grid.eleven-up .col, [owa] .block-grid.eleven-up .col{width: 54px !important;}.ie-browser .block-grid.twelve-up .col, [owa] .block-grid.twelve-up .col{width: 50px !important;}@media only screen and (min-width: 620px){.block-grid{width: 600px !important;}.block-grid .col{vertical-align: top;}.block-grid .col.num12{width: 600px !important;}.block-grid.mixed-two-up .col.num4{width: 200px !important;}.block-grid.mixed-two-up .col.num8{width: 400px !important;}.block-grid.two-up .col{width: 300px !important;}.block-grid.three-up .col{width: 200px !important;}.block-grid.four-up .col{width: 150px !important;}.block-grid.five-up .col{width: 120px !important;}.block-grid.six-up .col{width: 100px !important;}.block-grid.seven-up .col{width: 85px !important;}.block-grid.eight-up .col{width: 75px !important;}.block-grid.nine-up .col{width: 66px !important;}.block-grid.ten-up .col{width: 60px !important;}.block-grid.eleven-up .col{width: 54px !important;}.block-grid.twelve-up .col{width: 50px !important;}}@media (max-width: 620px){.block-grid, .col{min-width: 320px !important; max-width: 100% !important; display: block !important;}.block-grid{width: calc(100% - 40px) !important;}.col{width: 100% !important;}.col>div{margin: 0 auto;}img.fullwidth, img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px; max-height: 0px; max-width: 0px; display: none; overflow: hidden; font-size: 0px;}}</style>" +
                            "</head><body class=\"clean-body\" style=\"margin: 0;padding: 0;-webkit-text-size-adjust: 100%;background-color: #F3F3F3\"> <style type=\"text/css\" id=\"media-query-bodytag\"> @media (max-width: 520px){.block-grid{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col{min-width: 320px !important; max-width: 100% !important; width: 100% !important; display: block !important;}.col>div{margin: 0 auto;}img.fullwidth{max-width: 100% !important;}img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important; display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack.mixed-two-up .col.num4{width: 33% !important;}.no-stack.mixed-two-up .col.num8{width: 66% !important;}.no-stack.three-up .col.num4{width: 33% !important;}.no-stack.four-up .col.num3{width: 25% !important;}.mobile_hide{min-height: 0px !important; max-height: 0px !important; max-width: 0px !important; display: none !important; overflow: hidden !important; font-size: 0px !important;}}</style> <table class=\"nl-container\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #F3F3F3;width: 100%\" cellpadding=\"0\" cellspacing=\"0\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top\"> <div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> &#160; </div></div></div></div></div></div><div style=\"background-color:#F3F3F3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: #FFFFFF;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:#FFFFFF;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <div align=\"center\" class=\"img-container center fixedwidth \" style=\"background:#051829;padding-right: 10px; padding-left: 10px;\"> <div style=\"line-height:10px;font-size:1px\">&#160;</div><a  target=\"_blank\"> <img class=\"center fixedwidth\" align=\"center\" border=\"0\" src=\"" + logo + "\" alt=\"Image\" title=\"Image\" style=\"outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: block !important;border: none;height: auto;float: none;width: 100%;max-width: 240px\" width=\"240\"> </a> <div style=\"line-height:10px;font-size:1px\">&#160;</div></div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: #FFFFFF; width: 100% !important;\">" +
                            "<div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:0px; padding-bottom:0px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 5px;padding-left: 5px;padding-top: 5px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span></span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#134C75;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:120%; padding-right: 30px; padding-left: 30px; padding-top: 10px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:14px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#134C75;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 24px; line-height: 28px;\"><strong>" + titles + "</strong></span></p></div></div></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 10px;padding-left: 10px;padding-top: 15px;padding-bottom: 5px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 1px solid #DDDDDD;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> <div class=\"\"> <div style=\"color:#4A4A4A;font-family:'Bitter', Georgia, Times, 'Times New Roman', serif;line-height:180%; padding-right: 25px; padding-left: 25px; padding-top: 15px; padding-bottom: 5px;\"> <div style=\"font-size:12px;line-height:22px;font-family:Bitter, Georgia, Times, 'Times New Roman', serif;color:#4A4A4A;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 25px\"><span style=\"font-size: 15px; line-height: 27px;\"><strong><span style=\"line-height: 27px; font-size: 15px;\">Estimado usuario:</span></strong></span><span style=\"font-size: 14px; line-height: 25px;\"><span style=\"line-height: 25px; font-size: 14px;\"></span></span></p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family: Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 0px;\">" +
                            "<div style=\"font-size:12px;line-height:18px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;margin-left: 25px\"> <p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left\"> <span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\">" +
                            "" + dataInfosL + "<br>" +
                            "</span> </p><p style=\"margin: 0;font-size: 14px;line-height: 21px;text-align: left; margin-top: 10px; margin-left: 15px\"><span style=\"font-size: 14px; line-height: 21px;\"> <span style=\"line-height: 21px; font-size: 14px;\"><br>" +
                            "</span> </p></div></div></div><div class=\"\"> <div style=\"color:#3c3c3c;font-family:Arial, Georgia, Times, 'Times New Roman', serif;line-height:150%; padding-right: 30px; padding-left: 30px; padding-top: 5px; padding-bottom: 20px;\"> <div style=\"line-height:18px;font-size:12px;font-family:Open Sans, Georgia, Times, 'Times New Roman', serif;color:#000000;text-align:left;\"> <p style=\"margin: 0;line-height: 18px;text-align: left;font-size: 12px\"><span style=\"font-size: 14px; line-height: 21px;\">Para más información haga click en el siguiente enlace:</span></p></div></div></div><div align=\"center\" class=\"button-container center \" style=\"padding-right: 10px; padding-left: 10px; padding-top:10px; padding-bottom:10px;\">" +
                            "<a href=\"" + liga + "\" target=\"_blank\" style=\"display: block;text-decoration: none;-webkit-text-size-adjust: none;text-align: center;color: #ffffff; background-color: #49a6e8; border-radius: 24px; -webkit-border-radius: 24px; -moz-border-radius: 24px; max-width: 152px; width: 102px;width: auto; border-top: 0px solid transparent; border-right: 0px solid transparent; border-bottom: 0px solid transparent; border-left: 0px solid transparent; padding-top: 5px; padding-right: 25px; padding-bottom: 5px; padding-left: 25px; font-family: Arial, Helvetica, Arial, sans-serif;mso-border-alt: none\"> <span style=\"font-family:Arial, Helvetica, Arial, sans-serif;font-size:16px;line-height:32px;\"><span style=\"font-size: 14px;\">Consultar aquí</span></span> </a> </div><div class=\"\"> <div style=\"color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;line-height:120%; padding-right: 10px; padding-left: 10px; padding-top: 15px; padding-bottom: 10px;\"> <div style=\"font-size:12px;line-height:14px;color:#8F8F8F;font-family:Arial, Helvetica, Arial, sans-serif;text-align:left;\"> <p style=\"margin: 0;font-size: 14px;line-height: 17px;text-align: center\"><span style=\"font-size: 11px; line-height: 13px;\"></span><span style=\"font-size: 11px; line-height: 13px;\">" +
                            "<a style=\"color:#8F8F8F;text-decoration: underline;\" href=\"" + liga + "\" target=\"_blank\" rel=\"noopener\"></a></span></p></div></div></div><div align=\"center\" class=\"img-container center autowidth fullwidth \" style=\"padding-right: 0px; padding-left: 0px;\"> </div></div></div></div></div></div></div><div style=\"background-color:#f3f3f3;\"> <div style=\"Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;\" class=\"block-grid \"> <div style=\"border-collapse: collapse;display: table;width: 100%;background-color:transparent;\"> <div class=\"col num12\" style=\"min-width: 320px;max-width: 600px;display: table-cell;vertical-align: top;\"> <div style=\"background-color: transparent; width: 100% !important;\"> <div style=\"border-top: 0px solid transparent; border-left: 0px solid transparent; border-bottom: 0px solid transparent; border-right: 0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"divider \" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 100%;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td class=\"divider_inner\" style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;padding-right: 25px;padding-left: 25px;padding-top: 25px;padding-bottom: 25px;min-width: 100%;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <table class=\"divider_content\" height=\"0px\" align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;border-top: 0px solid transparent;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <tbody> <tr style=\"vertical-align: top\"> <td style=\"word-break: break-word;border-collapse: collapse !important;vertical-align: top;font-size: 0px;line-height: 0px;mso-line-height-rule: exactly;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%\"> <span>&#160;</span> </td></tr></tbody> </table> </td></tr></tbody> </table> </div></div></div></div></div></div></td></tr></tbody> </table> </body></html>"
                        var mailOptions = {
                            from: 'NoReplay <librosdemexico@outlook.com>',
                            replyTo: 'librosdemexico@outlook.com',
                            to: email,
                            subject: titles,
                            html: message
                        };
                        transporter.sendMail(mailOptions, function (error, info) {
                            let body = {
                                "success": true,
                                "pass": pass,
                                "mess": "Correo enviado a " + email
                            }
                            response.success(req, res, false, true, body, 200)
                        })
                    })
                }
            })
        }
    } catch (error) {
    }
})

router.post("/api/updatePassword", async (req, res) => {
    var array = []
    const { email, newPass } = req.body;
    mysqlConection.query('SELECT * FROM users WHERE correo = ?', [email], async (error, results) => {
        const id = results[0].id
        console.log(newPass)
        let passHash = await bcryptjs.hash(newPass, 8)
        array.push(passHash)
        array.push("@@@@@@")
        array.push(id)
        console.log(id)
        const query = "UPDATE users SET pass=?, temporal = ? WHERE (id = ?)";
        mysqlConection.query(query, array, (err, rows, fields) => {
            let body = {
                "mess": "Contraseña actualizada"
            }
            response.success(req, res, false, true, body, 200)
        })
    })
})
router.post("/api/resetPassword", async (req, res) => {
    var array = []
    try {
        const { email, newPass, oldPass } = req.body;
        if (!email) {
            response.error(req, res, true, false, "Ingrese un correo", 401, "Ingrese un correo");
        } else if (!oldPass) {
            response.error(req, res, true, false, "Ingrese la contraseña que se envio por correo", 401, "Ingrese un correo");
        } else if (!newPass) {
            response.error(req, res, true, false, "Ingrese una contraseña nueva", 401, "Ingrese un correo");
        } else {
            mysqlConection.query('SELECT * FROM users WHERE correo = ?', [email], async (error, results) => {
                const id = results[0].id
                if (results.length == 0) {
                    response.error(req, res, true, false, "Correo/ contraseña invalida", 401, "Correo/ contraseña invalida");
                } else if (!(await bcryptjs.compare(oldPass, results[0].temporal))) {
                    response.error(req, res, true, false, "Correo/ contraseña invalida", 401, "Correo/ contraseña invalida");
                } else {
                    let passHash = await bcryptjs.hash(newPass, 8)
                    array.push(passHash)
                    array.push("@@@@@@")
                    array.push(id)
                    const query = "UPDATE users SET pass=?, temporal = ? WHERE (id = ?)";
                    mysqlConection.query(query, array, (err, rows, fields) => {
                        const token = jwt.sign({ id: id }, "secret_token", {
                            expiresIn: "8h"
                        })
                        const cookiesOptions = {
                            expires: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),
                            httpOnly: true
                        }
                        let profile = results[0].tipo;
                        let emailUser = email;
                        let nameUser = results[0].nombre
                        let body = {
                            'is_security': token,
                            'is_Profile': profile,
                            'is_Emial': emailUser,
                            'is_Name': nameUser,
                            "success": true,
                            "mess": "Bienvenido " + results[0].nombre,
                            expires: cookiesOptions.expires
                        }
                        response.success(req, res, false, true, body, 200)
                    })
                }
            })
        }
    } catch (error) {
    }
})
// Authorization: Bearer <token>
function verifyToken(req, res, next) {
    const bearerHeader = req.headers['authorization'];
    if (typeof bearerHeader !== 'undefined') {
        const bearerToken = bearerHeader.split(" ")[1];
        req.token = bearerToken;
        next();
    } else {
        response.error(req, res, true, false, "Prohibido", 403, "Prohibido")
    }
}
module.exports = router; //Exporta la ruta */